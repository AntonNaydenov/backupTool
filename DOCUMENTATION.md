# Инструмент резервного копирования

Этот инструмент предназначен для создания резервных копий баз данных MySQL и веб-сайтов с возможностью загрузки в хранилище S3.

## Основные функции

1. **Резервное копирование баз данных MySQL**:
   - Создание дампов схем и данных для каждой таблицы отдельно
   - Поддержка многопоточности для ускорения процесса
   - Сохранение дампов в отдельные файлы для каждой таблицы

2. **Резервное копирование веб-сайтов**:
   - Загрузка файлов веб-сайтов в хранилище S3

3. **Интеграция с S3**:
   - Загрузка резервных копий в хранилище S3
   - Поддержка архивации перед загрузкой
   - Многопоточная загрузка файлов

## Структура конфигурационного файла

Конфигурационный файл использует формат YAML и имеет следующую структуру:

```yaml
global:
  archive: true  # Включить архивацию перед загрузкой в S3
  tmpDir: /tmp   # Временная директория для хранения дампов
  sourceDir: /var/www/html  # Исходная директория веб-сайта
  concurrency: 5 # Количество параллельных потоков

web_site:
  enable: true   # Включить резервное копирование веб-сайтов
  list:
    - name: mysite    # Название веб-сайта
      path: /var/www/html  # Путь к файлам веб-сайта

s3_config:
  enable: true         # Включить загрузку в S3
  bucket: my-bucket    # Название бакета S3
  endpoint: s3.amazonaws.com  # Endpoint S3
  accessKey: YOUR_ACCESS_KEY  # Ключ доступа к S3
  secretKey: YOUR_SECRET_KEY  # Секретный ключ доступа к S3
  useSSL: true         # Использовать SSL при подключении к S3

database:
  enable: true         # Включить резервное копирование баз данных
  host: localhost      # Хост базы данных
  port: 3306           # Порт базы данных
  user: root           # Пользователь базы данных
  password: password   # Пароль пользователя базы данных
  database_list:
    - mydb             # Список баз данных для резервного копирования
```

## Использование

Для запуска инструмента используйте следующую команду:

```bash
./backup_tool -f /path/to/config.yaml
```

Где `-f` указывает путь к конфигурационному файлу. По умолчанию используется путь `/etc/bckupTool/config.yaml`.

## Архитектура и реализация

### Основные компоненты

1. **main.go** - Главный файл программы, содержащий точку входа и основную логику:
   - Парсинг конфигурационного файла
   - Управление процессом резервного копирования
   - Координация между компонентами

2. **dumpDB.go** - Модуль для работы с базами данных:
   - Подключение к базе данных
   - Получение списка таблиц
   - Создание дампов схем и данных таблиц
   - Многопоточное выполнение операций дампа

3. **s3_client.go** - Модуль для работы с хранилищем S3:
   - Загрузка файлов в S3
   - Архивация директорий перед загрузкой
   - Многопоточная загрузка файлов

4. **archive.go** - Модуль для архивации директорий:
   - Создание tar.gz архивов

### Процесс резервного копирования баз данных

1. Подключение к каждой базе данных из списка в конфигурации
2. Создание временной директории для дампов
3. Получение списка таблиц в базе данных
4. Для каждой таблицы в параллельных потоках:
   - Создание дампа схемы таблицы
   - Создание дампа данных таблицы
5. При включенной загрузке в S3:
   - Архивация директории с дампами (если включено)
   - Загрузка файлов в S3 в параллельных потоках

### Процесс резервного копирования веб-сайтов

1. Для каждого веб-сайта из списка в конфигурации:
   - Архивация файлов веб-сайта (если включено)
   - Загрузка файлов в S3 в параллельных потоках

## Примеры использования

### Пример конфигурационного файла для резервного копирования базы данных

```yaml
global:
  archive: false
  tmpDir: /tmp
  concurrency: 3

s3_config:
  enable: true
  bucket: backup-bucket
  endpoint: s3.amazonaws.com
  accessKey: YOUR_ACCESS_KEY
  secretKey: YOUR_SECRET_KEY
  useSSL: true

database:
  enable: true
  host: localhost
  port: 3306
  user: backup_user
  password: backup_password
  database_list:
    - production_db
    - staging_db
```

### Пример конфигурационного файла для резервного копирования веб-сайта

```yaml
global:
  archive: true
  tmpDir: /tmp
  concurrency: 5

web_site:
  enable: true
  list:
    - name: mywebsite
      path: /var/www/mywebsite

s3_config:
  enable: true
  bucket: backup-bucket
  endpoint: s3.amazonaws.com
  accessKey: YOUR_ACCESS_KEY
  secretKey: YOUR_SECRET_KEY
  useSSL: true

database:
  enable: false
```

## Логирование

Все операции логируются в файл `/var/log/bckupTool.log`. Логи содержат информацию о:
- Подключении к базам данных
- Создании дампов
- Загрузке файлов в S3
- Ошибках и предупреждениях

## Требования

- Go 1.16 или выше
- Доступ к базе данных MySQL
- Доступ к хранилищу S3 (при включенной загрузке в S3)
- Права на запись в временные директории

## Установка и сборка

1. Клонируйте репозиторий:
   ```bash
   git clone <repository-url>
   cd backup_tool
   ```

2. Соберите проект:
   ```bash
   go build -o backup_tool
   ```

3. Создайте конфигурационный файл на основе `config.yaml.sample`:
   ```bash
   cp config.yaml.sample config.yaml
   # Отредактируйте config.yaml согласно вашим настройкам
   ```

4. Запустите инструмент:
   ```bash
   ./backup_tool -f /path/to/config.yaml